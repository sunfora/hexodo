#!/usr/bin/bash

# === Config ===
export PORT=8085
export ROUTER="router.php"
export HOST="localhost"
export URL="http://$HOST:$PORT"
export LOCKFILE=".lock"

# === Aliases ===
alias s="start_server"
alias o="open_in_browser"
alias r="restart_server"
alias e="nvim $ROUTER"
alias x='stop_server'

# === Commands ===
open_in_browser() {
  if command -v xdg-open &>/dev/null; then
    xdg-open "$URL"
  elif command -v open &>/dev/null; then
    open "$URL"
  else
    echo "No browser opener found (xdg-open or open)"
    return 1
  fi
}

start_server() {
  exec 9>"$LOCKFILE"  # open file descriptor 9 for LOCKFILE

  if ! flock -n 9; then
    echo "Server already running (lock is held)"
    return 1
  fi

  # Start server only if lock was acquired
  echo "Starting server at $URL ..."
  php -S "$HOST:$PORT" "$ROUTER" > server.log 2>&1 &
  export SERVER_PID=$!
  echo "$SERVER_PID"  # Optional: show PID
}

stop_server() {
  if kill "$SERVER_PID" >/dev/null 2>&1; then
    echo "Stopped server (PID $SERVER_PID)"
  else
    echo "Failed to stop server"
  fi
  exec 9>&-  
}

restart_server() {
  echo "Restarting server..."
  stop_server
  sleep 0.5
  start_server
}

# === Message on load ===
echo "Direnv loaded. Use:"
echo "  s  → start server (flock protected)"
echo "  x  → stop server"
echo "  r  → restart server"
echo "  o  → open in browser"
echo "  e  → edit router.php"

